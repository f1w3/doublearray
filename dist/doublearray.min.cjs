// Copyright (c) 2014 Takuya Asano All Rights Reserved.
// rewrite by @f1w3_ | 2024

"use strict";
var{defineProperty:W,getOwnPropertyNames:I,getOwnPropertyDescriptor:S}=Object,C=Object.prototype.hasOwnProperty;var Y=new WeakMap,T=(G)=>{var E=Y.get(G),q;if(E)return E;if(E=W({},"__esModule",{value:!0}),G&&typeof G==="object"||typeof G==="function")I(G).map((K)=>!C.call(E,K)&&W(E,K,{get:()=>G[K],enumerable:!(q=S(G,K))||q.enumerable}));return Y.set(G,E),E};var U=(G,E)=>{for(var q in E)W(G,q,{get:E[q],enumerable:!0,configurable:!0,set:(K)=>E[q]=()=>K})};var m={};U(m,{default:()=>B,DoubleArrayBuilder:()=>X,DoubleArray:()=>P});module.exports=T(m);var Q=(G,E,q)=>{if(G)switch(E){case 1:return new Int8Array(q);case 2:return new Int16Array(q);case 4:return new Int32Array(q);default:throw new RangeError("Invalid newArray parameter element_bytes:"+E)}else switch(E){case 1:return new Uint8Array(q);case 2:return new Uint16Array(q);case 4:return new Uint32Array(q);default:throw new RangeError("Invalid newArray parameter element_bytes:"+E)}},v=(G,E,q)=>{var K=new ArrayBuffer(q),F=new Uint8Array(K,0,q),H=G.subarray(E,q);return F.set(H),F},R=(G)=>{let E=new Uint8Array(G.length*4),q=0;for(let K=0;K<G.length;K++){let F=G.charCodeAt(K);if(F>=55296&&F<=56319)if(K+1<G.length){let H=G.charCodeAt(++K);if(H>=56320&&H<=57343)F=(F-55296<<10)+(H-56320)+65536;else return null}else return null;if(F<128)E[q++]=F;else if(F<2048)E[q++]=192|F>>>6,E[q++]=128|F&63;else if(F<65536)E[q++]=224|F>>>12,E[q++]=128|F>>>6&63,E[q++]=128|F&63;else if(F<1114112)E[q++]=240|F>>>18,E[q++]=128|F>>>12&63,E[q++]=128|F>>>6&63,E[q++]=128|F&63;else return null}return E.subarray(0,q)},j=(G)=>{let E=[],q=0;while(q<G.length){let K=G[q++],F;if(K<128)F=K;else if(K>>5===6){let H=G[q++];F=(K&31)<<6|H&63}else if(K>>4===14){let H=G[q++],J=G[q++];F=(K&15)<<12|(H&63)<<6|J&63}else{let H=G[q++],J=G[q++],L=G[q++];F=(K&7)<<18|(H&63)<<12|(J&63)<<6|L&63}if(F<65536)E.push(String.fromCharCode(F));else F-=65536,E.push(String.fromCharCode(55296|F>>10)),E.push(String.fromCharCode(56320|F&1023))}return E.join("")},Z=(G=1024)=>{let E=(L,M,N)=>{if(!J.array)throw new Error("check array is not initialized");for(let O=M;O<N;O++)L[O]=-O+1;if(0<J.array[J.array.length-1]){let O=J.array.length-2;while(0<J.array[O])O--;L[M]=-O}},q=(L,M,N)=>{for(let O=M;O<N;O++)L[O]=-O-1},K=(L)=>{let M=L*2,N=Q(H.signed,H.bytes,M);if(!H.array)throw new Error("realloc failed. base.array is null");E(N,H.array.length,M),N.set(H.array),H.array=null,H.array=N;let O=Q(J.signed,J.bytes,M);if(!J.array)throw new Error("realloc failed. check.array is null");q(O,J.array.length,M),O.set(J.array),J.array=null,J.array=O},F=1,H={signed:!0,bytes:4,array:Q(!0,4,G)},J={signed:!0,bytes:4,array:Q(!0,4,G)};if(!H.array)throw new Error("base.array is null");if(!J.array)throw new Error("check.array is null");return H.array[0]=1,J.array[0]=0,E(H.array,1,H.array.length),q(J.array,1,J.array.length),{getBaseBuffer:()=>{return H.array},getCheckBuffer:()=>{return J.array},loadBaseBuffer:(L)=>{return H.array=L,null},loadCheckBuffer:(L)=>{return J.array=L,null},size:()=>{if(!H.array)throw new Error("base.array is null");if(!J.array)throw new Error("check.array is null");return Math.max(H.array.length,J.array.length)},getBase:(L)=>{if(!H.array)throw new Error("base.array is null");if(H.array.length-1<L)return-L+1;return H.array[L]},getCheck:(L)=>{if(!J.array)throw new Error("check.array is null");if(J.array.length-1<L)return-L-1;return J.array[L]},setBase:(L,M)=>{if(!H.array)throw new Error("base.array is null");if(H.array.length-1<L)K(L);H.array[L]=M},setCheck:(L,M)=>{if(!J.array)throw new Error("check.array is null");if(J.array.length-1<L)K(L);J.array[L]=M},setFirstUnusedNode:(L)=>{F=L},getFirstUnusedNode:function(){return F},shrink:()=>{if(!H.array)throw new Error("base.array is null");if(!J.array)throw new Error("check.array is null");let L=Math.max(H.array.length,J.array.length);while(!0){if(0<=J.array[L])break;L--}H.array=H.array.subarray(0,L+2),J.array=J.array.subarray(0,L+2)},calc:()=>{if(!H.array)throw new Error("base.array is null");if(!J.array)throw new Error("check.array is null");let L=0,M=J.array.length;for(let N=0;N<M;N++)if(J.array[N]<0)L++;return{all:M,unused:L,efficiency:(M-L)/M}},dump:()=>{if(!H.array)throw new Error("base.array is null");if(!J.array)throw new Error("check.array is null");let L="",M="";for(let N of H.array)L=L+" "+N;for(let N of J.array)M=M+" "+N;return console.log("base:"+L),console.log("chck:"+M),"base:"+L+" chck:"+M}}};class X{bc;keys;constructor(G=1024){this.bc=Z(G),this.keys=[]}append(G,E){return this.keys.push({k:G,v:E}),this}build(G=this.keys,E=!1){if(G==null)return new P(this.bc);let q=G.map((K)=>{return{k:R(K.k+"\0"),v:K.v}});if(E)this.keys=q;else this.keys=q.sort((K,F)=>{let H=K.k,J=F.k,L=Math.min(H.length,J.length);for(let M=0;M<L;M++){if(H[M]===J[M])continue;return H[M]-J[M]}return H.length-J.length});return q=null,this._build(0,0,0,this.keys.length),new P(this.bc)}_build(G,E,q,K){let F=this.getChildrenInfo(E,q,K),H=this.findAllocatableBase(F);this.setBC(G,F,H);let J=0;for(let L of F){if(L===0)continue;let M=F[J+1],N=F[J+2],O=H+L;this._build(O,E+1,M,N),J=J+1}}getChildrenInfo(G,E,q){let K=this.keys[E].k[G],F=new Int32Array(q*3),H=0;F[H++]=parseInt(K),F[H++]=E;let J=E,L=E;for(;J<E+q;J++){let M=this.keys[J].k[G];if(K!==M)F[H++]=J-L,F[H++]=parseInt(M),F[H++]=J,K=M,L=J}return F[H++]=J-L,F=F.subarray(0,H),F}setBC(G,E,q){let K=this.bc;K.setBase(G,q);let F=0;for(let H of E){let J=q+H,L=-K.getBase(J),M=-K.getCheck(J);if(J!==K.getFirstUnusedNode())K.setCheck(L,-M);else K.setFirstUnusedNode(M);K.setBase(M,-L);let N=G;if(K.setCheck(J,N),H===0){let O=E[F+1],V=this.keys[O].v;if(V==null)V=0;let $=-V-1;K.setBase(J,$)}F=F+1}}findAllocatableBase(G){let E=this.bc,q,K=E.getFirstUnusedNode();while(!0){if(q=K-G[0],q<0){K=-E.getCheck(K);continue}let F=!0;for(let H of G){let J=q+H;if(!this.isUnusedNode(J)){K=-E.getCheck(K),F=!1;break}}if(F)return q}}isUnusedNode(G){let q=this.bc.getCheck(G);if(G===0)return!1;if(q<0)return!0;return!1}}class P{bc;constructor(G){this.bc=G,this.bc.shrink()}contain(G){let E=this.bc;G+="\0";let q=R(G);if(!q)throw new Error("invalid key");let K=0,F=-1;for(let H of q){if(F=this.traverse(K,H),F===-1)return!1;if(E.getBase(F)<=0)return!0;else{K=F;continue}}return!1}lookup(G){G+="\0";let E=R(G);if(!E)throw new Error("invalid key");let q=0,K=-1;for(let H of E){if(K=this.traverse(q,H),K===-1)return-1;q=K}let F=this.bc.getBase(K);if(F<=0)return-F-1;else return-1}commonPrefixSearch(G){let E=R(G);if(!E)throw new Error("invalid key");let q=[],K=0,F=-1,H=0;for(let J of E){if(F=this.traverse(K,J),F!==-1){K=F;let L=this.traverse(F,0);if(L!==-1){let M=this.bc.getBase(L),N={k:"",v:-1};if(M<=0)N.v=-M-1;N.k=j(v(E,0,H+1)),q.push(N)}continue}else break;H=H+1}return q}traverse(G,E){let q=this.bc.getBase(G)+E;if(this.bc.getCheck(q)===G)return q;else return-1}size(){return this.bc.size()}calc(){return this.bc.calc()}dump(){return this.bc.dump()}}var D={builder:(G=1024)=>{return new X(G)},load:(G,E)=>{let q=Z(0);return q.loadBaseBuffer(G),q.loadCheckBuffer(E),new P(q)}};var B=D;

//# debugId=0C534CDE6855371964756E2164756E21
//# sourceMappingURL=doublearray.min.cjs.map
