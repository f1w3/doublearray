// Copyright (c) 2014 Takuya Asano All Rights Reserved.
// rewrite by @f1w3_ | 2024

var P=(J,H,E)=>{if(J)switch(H){case 1:return new Int8Array(E);case 2:return new Int16Array(E);case 4:return new Int32Array(E);default:throw new RangeError("Invalid newArray parameter element_bytes:"+H)}else switch(H){case 1:return new Uint8Array(E);case 2:return new Uint16Array(E);case 4:return new Uint32Array(E);default:throw new RangeError("Invalid newArray parameter element_bytes:"+H)}},Z=(J,H,E)=>{var L=new ArrayBuffer(E),q=new Uint8Array(L,0,E),F=J.subarray(H,E);return q.set(F),q},Q=(J)=>{let H=new Uint8Array(J.length*4),E=0;for(let L=0;L<J.length;L++){let q=J.charCodeAt(L);if(q>=55296&&q<=56319)if(L+1<J.length){let F=J.charCodeAt(++L);if(F>=56320&&F<=57343)q=(q-55296<<10)+(F-56320)+65536;else return null}else return null;if(q<128)H[E++]=q;else if(q<2048)H[E++]=192|q>>>6,H[E++]=128|q&63;else if(q<65536)H[E++]=224|q>>>12,H[E++]=128|q>>>6&63,H[E++]=128|q&63;else if(q<1114112)H[E++]=240|q>>>18,H[E++]=128|q>>>12&63,H[E++]=128|q>>>6&63,H[E++]=128|q&63;else return null}return H.subarray(0,E)},$=(J)=>{let H=[],E=0;while(E<J.length){let L=J[E++],q;if(L<128)q=L;else if(L>>5===6){let F=J[E++];q=(L&31)<<6|F&63}else if(L>>4===14){let F=J[E++],G=J[E++];q=(L&15)<<12|(F&63)<<6|G&63}else{let F=J[E++],G=J[E++],K=J[E++];q=(L&7)<<18|(F&63)<<12|(G&63)<<6|K&63}if(q<65536)H.push(String.fromCharCode(q));else q-=65536,H.push(String.fromCharCode(55296|q>>10)),H.push(String.fromCharCode(56320|q&1023))}return H.join("")},W=(J=1024)=>{let H=(K,M,N)=>{if(!G.array)throw new Error("check array is not initialized");for(let O=M;O<N;O++)K[O]=-O+1;if(0<G.array[G.array.length-1]){let O=G.array.length-2;while(0<G.array[O])O--;K[M]=-O}},E=(K,M,N)=>{for(let O=M;O<N;O++)K[O]=-O-1},L=(K)=>{let M=K*2,N=P(F.signed,F.bytes,M);if(!F.array)throw new Error("realloc failed. base.array is null");H(N,F.array.length,M),N.set(F.array),F.array=null,F.array=N;let O=P(G.signed,G.bytes,M);if(!G.array)throw new Error("realloc failed. check.array is null");E(O,G.array.length,M),O.set(G.array),G.array=null,G.array=O},q=1,F={signed:!0,bytes:4,array:P(!0,4,J)},G={signed:!0,bytes:4,array:P(!0,4,J)};if(!F.array)throw new Error("base.array is null");if(!G.array)throw new Error("check.array is null");return F.array[0]=1,G.array[0]=0,H(F.array,1,F.array.length),E(G.array,1,G.array.length),{getBaseBuffer:()=>{return F.array},getCheckBuffer:()=>{return G.array},loadBaseBuffer:(K)=>{return F.array=K,null},loadCheckBuffer:(K)=>{return G.array=K,null},size:()=>{if(!F.array)throw new Error("base.array is null");if(!G.array)throw new Error("check.array is null");return Math.max(F.array.length,G.array.length)},getBase:(K)=>{if(!F.array)throw new Error("base.array is null");if(F.array.length-1<K)return-K+1;return F.array[K]},getCheck:(K)=>{if(!G.array)throw new Error("check.array is null");if(G.array.length-1<K)return-K-1;return G.array[K]},setBase:(K,M)=>{if(!F.array)throw new Error("base.array is null");if(F.array.length-1<K)L(K);F.array[K]=M},setCheck:(K,M)=>{if(!G.array)throw new Error("check.array is null");if(G.array.length-1<K)L(K);G.array[K]=M},setFirstUnusedNode:(K)=>{q=K},getFirstUnusedNode:function(){return q},shrink:()=>{if(!F.array)throw new Error("base.array is null");if(!G.array)throw new Error("check.array is null");let K=Math.max(F.array.length,G.array.length);while(!0){if(0<=G.array[K])break;K--}F.array=F.array.subarray(0,K+2),G.array=G.array.subarray(0,K+2)},calc:()=>{if(!F.array)throw new Error("base.array is null");if(!G.array)throw new Error("check.array is null");let K=0,M=G.array.length;for(let N=0;N<M;N++)if(G.array[N]<0)K++;return{all:M,unused:K,efficiency:(M-K)/M}},dump:()=>{if(!F.array)throw new Error("base.array is null");if(!G.array)throw new Error("check.array is null");let K="",M="";for(let N of F.array)K=K+" "+N;for(let N of G.array)M=M+" "+N;return console.log("base:"+K),console.log("chck:"+M),"base:"+K+" chck:"+M}}};class X{bc;keys;constructor(J=1024){this.bc=W(J),this.keys=[]}append(J,H){return this.keys.push({k:J,v:H}),this}build(J=this.keys,H=!1){if(J==null)return new R(this.bc);let E=J.map((L)=>{return{k:Q(L.k+"\0"),v:L.v}});if(H)this.keys=E;else this.keys=E.sort((L,q)=>{let F=L.k,G=q.k,K=Math.min(F.length,G.length);for(let M=0;M<K;M++){if(F[M]===G[M])continue;return F[M]-G[M]}return F.length-G.length});return E=null,this._build(0,0,0,this.keys.length),new R(this.bc)}_build(J,H,E,L){let q=this.getChildrenInfo(H,E,L),F=this.findAllocatableBase(q);this.setBC(J,q,F);let G=0;for(let K of q){if(K===0)continue;let M=q[G+1],N=q[G+2],O=F+K;this._build(O,H+1,M,N),G=G+1}}getChildrenInfo(J,H,E){let L=this.keys[H].k[J],q=new Int32Array(E*3),F=0;q[F++]=parseInt(L),q[F++]=H;let G=H,K=H;for(;G<H+E;G++){let M=this.keys[G].k[J];if(L!==M)q[F++]=G-K,q[F++]=parseInt(M),q[F++]=G,L=M,K=G}return q[F++]=G-K,q=q.subarray(0,F),q}setBC(J,H,E){let L=this.bc;L.setBase(J,E);let q=0;for(let F of H){let G=E+F,K=-L.getBase(G),M=-L.getCheck(G);if(G!==L.getFirstUnusedNode())L.setCheck(K,-M);else L.setFirstUnusedNode(M);L.setBase(M,-K);let N=J;if(L.setCheck(G,N),F===0){let O=H[q+1],V=this.keys[O].v;if(V==null)V=0;let Y=-V-1;L.setBase(G,Y)}q=q+1}}findAllocatableBase(J){let H=this.bc,E,L=H.getFirstUnusedNode();while(!0){if(E=L-J[0],E<0){L=-H.getCheck(L);continue}let q=!0;for(let F of J){let G=E+F;if(!this.isUnusedNode(G)){L=-H.getCheck(L),q=!1;break}}if(q)return E}}isUnusedNode(J){let E=this.bc.getCheck(J);if(J===0)return!1;if(E<0)return!0;return!1}}class R{bc;constructor(J){this.bc=J,this.bc.shrink()}contain(J){let H=this.bc;J+="\0";let E=Q(J);if(!E)throw new Error("invalid key");let L=0,q=-1;for(let F of E){if(q=this.traverse(L,F),q===-1)return!1;if(H.getBase(q)<=0)return!0;else{L=q;continue}}return!1}lookup(J){J+="\0";let H=Q(J);if(!H)throw new Error("invalid key");let E=0,L=-1;for(let F of H){if(L=this.traverse(E,F),L===-1)return-1;E=L}let q=this.bc.getBase(L);if(q<=0)return-q-1;else return-1}commonPrefixSearch(J){let H=Q(J);if(!H)throw new Error("invalid key");let E=[],L=0,q=-1,F=0;for(let G of H){if(q=this.traverse(L,G),q!==-1){L=q;let K=this.traverse(q,0);if(K!==-1){let M=this.bc.getBase(K),N={k:"",v:-1};if(M<=0)N.v=-M-1;N.k=$(Z(H,0,F+1)),E.push(N)}continue}else break;F=F+1}return E}traverse(J,H){let E=this.bc.getBase(J)+H;if(this.bc.getCheck(E)===J)return E;else return-1}size(){return this.bc.size()}calc(){return this.bc.calc()}dump(){return this.bc.dump()}}var I={builder:(J=1024)=>{return new X(J)},load:(J,H)=>{let E=W(0);return E.loadBaseBuffer(J),E.loadCheckBuffer(H),new R(E)}};var C=I;export{C as default,X as DoubleArrayBuilder,R as DoubleArray};

//# debugId=5C10647406EFCA3764756E2164756E21
//# sourceMappingURL=doublearray.browser.min.js.map
